<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFusion</title>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://api.themoviedb.org">
    <link rel="preconnect" href="https://image.tmdb.org">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --background-primary: #121212;
            --background-secondary: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #dedede;
            --accent-primary: #00E8FC;
            --accent-secondary: #7B42F6;
            --ui-element: #2c2c2c;
            --ui-hover: #454545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Arial", sans-serif;
            background-color: var(--background-primary);
            color: var(--text-primary);
            text-align: center;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            overflow-x: hidden;
        }

        /* Header styles */
        header {
            background-color: var(--background-secondary);
            color: var(--text-primary);
            padding: 0.2rem 0;
            display: flex;
            position: sticky;
            top: 0;
            z-index: 1000;
            align-items: center;
            height: 40px;
        }

        .header-content {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .logo {
            margin-left: 0.2rem;
        }

        h1 {
            display: flex;
            font-size: 1.5rem;
            margin: 0;
            padding: 0;
            flex-wrap: nowrap;
            text-align: center;
            align-items: center;
        }

        .highlight {
            color: var(--accent-primary);
        }

        .secondary-highlight {
            color: var(--accent-secondary);
        }

        .back-link,
        .report {
            display: block;
            text-decoration: none;
            color: var(--text-secondary);
            padding: 10px;
            font-size: 1.2rem;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .back-link:hover,
        .report:hover {
            color: var(--text-primary);
            background-color: var(--ui-hover);
        }

        /* Main container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            position: fixed;
            top: 40px;
            width: 100%;
        }

        /* Video container */
        #video-container {
            width: 100%;
            position: relative;
            background-color: #000;
            overflow: hidden;
        }

        /* Player styles */
        .player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background-color: #000;
            display: none;
        }

        .player.active {
            display: block;
        }

        /* Spinner */
        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 5px solid var(--ui-element);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Error message */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-primary);
            font-size: 18px;
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
        }

        /* Start message */
        .start-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 2vh;
            text-align: center;
        }

        /* Sidebar */
        .sidebar {
            width: 100%;
            height: 100%;
            display: flex;
            overflow-x: auto;
        }

        /* Category list */
        .category-list-container {
            min-width: 40%;
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            background-color: var(--background-secondary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        /* Channel list */
        .channel-list-container {
            min-width: 60%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--background-primary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        /* Search bar */
        .search-bar {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid var(--ui-element);
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            background-color: var(--ui-element);
            color: var(--text-primary);
        }

        .search-bar::placeholder {
            color: var(--text-secondary);
        }

        /* Category list */
        .category-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .category-list button {
            padding: 10px 0;
            background-color: transparent;
            color: var(--text-primary);
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: color 0.3s ease;
            text-align: left;
        }

        .category-list button.selected {
            color: var(--accent-primary);
            font-weight: bold;
        }

        /* Channel list */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.3s ease;
            padding: 10px;
            border-radius: 10px;
        }

        .channel-item:hover {
            background-color: var(--ui-element);
        }

        .channel-item.selected {
            background-color: var(--accent-secondary);
            border-radius: 10px;
            padding: 10px;
        }

        .channel-item.selected .channel-name {
            color: var(--text-primary);
        }

        .channel-logo {
            width: 50px;
            height: 50px;
            background-color: var(--background-primary);
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .channel-name {
            color: var(--text-primary);
        }

        /* Fullscreen button */
        .fullscreen-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-primary);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            z-index: 1001;
        }

        .fullscreen-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        /* Fullscreen menu */
        .fullscreen-menu {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1002;
            display: none;
        }

        .fullscreen-menu i {
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }

        /* Fullscreen overlay */
        .fullscreen-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1003;
            overflow-y: auto;
        }

        /* Overlay content */
        .overlay-content {
            display: flex;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            background-color: var(--background-primary);
            color: var(--text-primary);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }

        /* Category column */
        .category-column {
            width: 30%;
            max-height: 100%;
            overflow-y: auto;
        }

        .category-column h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        /* Channel column */
        .channel-column {
            width: 70%;
            max-height: 100%;
            overflow-y: auto;
            padding-left: 20px;
        }

        /* License dialog */
        .license-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .license-content {
            background-color: var(--background-secondary);
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .license-title {
            color: var(--accent-primary);
            margin-top: 0;
            font-size: 1.5rem;
        }

        .license-description {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .license-input-group {
            margin-bottom: 15px;
        }

        .license-label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .license-input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--ui-element);
            background-color: var(--ui-element);
            color: var(--text-primary);
            font-family: monospace;
            box-sizing: border-box;
        }

        .license-button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .license-button {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .license-primary {
            background-color: var(--accent-primary);
            color: var(--background-primary);
        }

        .license-secondary {
            background-color: var(--ui-element);
            color: var(--text-primary);
        }

        .license-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }

        .license-valid {
            background-color: var(--accent-primary);
            color: var(--background-primary);
        }

        .license-invalid {
            background-color: #e11d48;
            color: white;
            animation: pulse 2s infinite;
        }

        .license-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .license-toast-success {
            background-color: var(--accent-primary);
        }

        .license-toast-error {
            background-color: #e11d48;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        /* Responsive styles */
        @media (min-width: 768px) {
            .main-container {
                flex-direction: row;
            }

            #video-container {
                width: 60%;
                height: 100%;
            }

            .sidebar {
                width: 40%;
                flex-direction: row;
                overflow-x: hidden;
            }

            .category-list-container {
                width: 35%;
                min-width: auto;
                scrollbar-width: thin;
            }

            .channel-list-container {
                width: 65%;
                min-width: auto;
            }
        }

        @media (max-width: 767px) {
            #video-container {
                height: 230px;
            }
        }

        /* Scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--ui-element);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--ui-hover);
        }

        /* Player switch buttons */
        .player-switch-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            gap: 10px;
        }

        .player-switch-btn {
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-primary);
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .player-switch-btn.active {
            background-color: var(--accent-primary);
            color: var(--background-primary);
        }

        .player-switch-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        /* Reload button */
        .reload-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            z-index: 10;
        }

        .reload-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .reload-button:active {
            transform: scale(0.95);
        }

        .reload-button i {
            transition: transform 0.5s;
        }

        .reload-button.loading i {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Sistema de licencia -->
    <div id="license-dialog" class="license-dialog" style="display: none;">
        <div class="license-content">
            <h2 class="license-title">Activar StreamFusion</h2>
            <p class="license-description">Ingrese su clave de licencia para continuar</p>
            <div class="license-input-group">
                <label for="licenseKey" class="license-label">Clave de Licencia</label>
                <input type="text" id="licenseKey" class="license-input" value="" placeholder="SF-XXXX-XXXX">
            </div>
            <div class="license-button-group">
                <button id="activateButton" class="license-button license-primary">Activar</button>
            </div>
            <p id="license-message" class="license-message" style="color: #e11d48; margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="logo">
            <a href="go:home" class="back-link"><i class="fas fa-chevron-left"></i></a>
        </div>
        <div class="header-content">      	
            <h1><span class="highlight">Stream</span><span class="secondary-highlight">Fusion</span></h1>
        </div>
        <div class="logo">
            <a href="go:sr" class="report"><i class="fas fa-exclamation"></i></a>
        </div>
    </header>

    <!-- Contenedor principal -->
    <div class="main-container">
        <!-- Contenedor del reproductor -->
        <div id="video-container">
            <!-- Mensaje de inicio -->
            <div id="start-message" class="start-message">
                Selecciona un canal para comenzar
            </div>

            <!-- Reproductor para HLS/MP4 -->
            <video id="video-player" class="player" autoplay playsinline></video>

            <!-- Reproductor para iframe -->
            <iframe id="iframe-player" class="player" sandbox="allow-scripts allow-same-origin" scrolling="no" allowfullscreen="true" loading="lazy" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" msExitFullscreen="true" allow="encrypted-media"></iframe>
            
            <!-- Spinner -->
            <div id="spinner" class="spinner" style="display: none;"></div>

            <!-- Mensaje de error -->
            <div id="error-message" class="error-message" style="display: none;">
                No se pudo reproducir el canal.<br>Repórtalo para que sea actualizado.
            </div>

            <!-- Botón de recarga -->
            <button id="reload-button" class="reload-button" title="Recargar video" style="display: none;">
                <i class="fas fa-sync-alt"></i>
            </button>

            <!-- Botones de cambio de reproductor -->
            <div class="player-switch-container" style="display: none;">
                <button id="player1-btn" class="player-switch-btn active">Reproductor 1</button>
                <button id="player2-btn" class="player-switch-btn">Reproductor 2</button>
            </div>

            <!-- Botón de pantalla completa -->
            <button id="fullscreen-btn" class="fullscreen-btn">
                <i class="fas fa-expand"></i>
            </button>

            <!-- Botón de menú en pantalla completa -->
            <div class="fullscreen-menu" id="fullscreen-menu">
                <i class="fas fa-bars"></i>
            </div>

            <!-- Overlay para el menú en pantalla completa -->
            <div class="fullscreen-overlay" id="fullscreen-overlay">
                <div class="overlay-content" id="overlay-content">
                    <!-- Columna de categorías -->
                    <div class="category-column">
                        <h2>Categorías</h2>
                        <ul class="category-list" id="overlay-category-list">
                            <!-- Las categorías se cargarán dinámicamente -->
                        </ul>
                    </div>
                    
                    <!-- Columna de canales -->
                    <div class="channel-column">
                        <!-- Buscador en el overlay -->
                        <input type="text" class="search-bar" id="overlay-search-bar" placeholder="Buscar canal...">

                        <div class="channel-list" id="overlay-channel-list">
                            <!-- Los canales se cargarán dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra lateral (categorías y canales) -->
        <div class="sidebar">
            <!-- Contenedor de categorías -->
            <div class="category-list-container">
                <h2>Categorías</h2>
                <ul class="category-list" id="category-list">
                    <!-- Las categorías se cargarán dinámicamente -->
                </ul>
            </div>

            <!-- Contenedor de canales -->
            <div class="channel-list-container">
                <!-- Buscador en la barra lateral -->
                <input type="text" class="search-bar" id="sidebar-search-bar" placeholder="Buscar canal...">

                <h2>Canales</h2>
                <div class="channel-list" id="channel-list">
                    <!-- Los canales se cargarán dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- HLS.js library for HLS streaming support -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        const videoPlayer = document.getElementById('video-player');
        const iframePlayer = document.getElementById('iframe-player');
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('error-message');
        const apiKey = "32e5e53999e380a0291d66fb304153fe";
        const startMessage = document.getElementById('start-message');
        const videoContainer = document.getElementById('video-container');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const fullscreenMenu = document.getElementById('fullscreen-menu');
        const fullscreenOverlay = document.getElementById('fullscreen-overlay');
        const overlayContent = document.getElementById('overlay-content');
        const licenseDialog = document.getElementById('license-dialog');
        const reloadButton = document.getElementById('reload-button');
        const player1Btn = document.getElementById('player1-btn');
        const player2Btn = document.getElementById('player2-btn');
        
        const sidebarSearchBar = document.getElementById('sidebar-search-bar');
        const overlaySearchBar = document.getElementById('overlay-search-bar');
        
        let selectedCategoryButton = null;
        let selectedChannelItem = null;
        let hlsInstance = null;
        let isLicenseValid = false;
        let currentChannel = null;
        let currentVideoUrl = '';
        let retryCount = 0;
        const MAX_RETRIES = 3;

        // Datos de categorías y canales
        const categories = [
            { id: "all", name: "Todos" },
            { id: "Argentina", name: "Argentina" },
            { id: "Colombia", name: "Colombia" },
            { id: "España", name: "España" },
            { id: "Mexico", name: "Mexico" },
            { id: "Venezuela", name: "Venezuela" },
            { id: "Cristiano", name: "Cristiano" },
            { id: "Musica", name: "Música" },
            { id: "Noticias", name: "Noticias" },
            { id: "Deportes", name: "Deportes" },
            { id: "Infantil", name: "Infantil" },
            { id: "Entretenimiento", name: "Entretenimiento" },
            { id: "Novelas", name: "Novelas" },
            { id: "Peliculas", name: "Películas" }
        ];

        const channels = [
            {
                id: "caracol-tv",
                name: "Caracol TV",
                logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/59/Caracol_Televisi%C3%B3n_logo.svg/512px-Caracol_Televisi%C3%B3n_logo.svg.png",
                type: "hls",
                source: "https://mdstrm.com/live-stream-playlist/574463697b9817cf0886fc17.m3u8",
                categories: ["Colombia"]
            },
            {
                id: "caracol-internacional",
                name: "Caracol Internacional",
                logo: "https://upload.wikimedia.org/wikipedia/commons/a/ab/Caracol_Internacional_2023.png",
                type: "iframe",
                source: "https://embed.sdfgnksbounce.com/embed2/caracol.html",
                categories: ["Colombia"]
            },
            {
                id: "rcn",
                name: "RCN",
                logo: "https://television-libre.net/img/rcn.webp",
                type: "iframe",
                source: "https://embed.sdfgnksbounce.com/embed2/rcn.html",
                categories: ["Colombia"]
            },
            {
                id: "canal-uno",
                name: "Canal UNO",
                logo: "https://canal1.com.co/icons/ios/152.png",
                type: "iframe",
                source: "https://unlimplayer.top/embed/oy3eFD1QxS9Ga5f",
                categories: ["Colombia"]
            },
            {
                id: "espn-argentina",
                name: "ESPN Argentina",
                logo: "https://television-libre.net//img/espn.webp",
                type: "iframe",
                source: "https://embed.sdfgnksbounce.com/embed2/espn.html",
                categories: ["Deportes", "Argentina"]
            },
            {
                id: "espn-2",
                name: "ESPN 2",
                logo: "https://television-libre.net//img/espn2.webp",
                type: "iframe",
                source: "https://embed.sdfgnksbounce.com/embed2/espn2.html",
                categories: ["Deportes"]
            }
        ];

        // Sistema de licencia avanzado
        const StreamFusionLicense = (() => {
            // MÓDULO DE CONFIGURACIÓN
            const Config = (() => { 
                // Función para codificar en Base64
                const encode = (str) => btoa(unescape(encodeURIComponent(str)));
                // Función para decodificar en Base64
                const decode = (str) => decodeURIComponent(escape(atob(str)));

                // Configuración privada con datos encriptados
                const _settings = {
                    isActivated: false,
                    defaultLicense: "SF-ABC123-TV",
                    licenseKey: "",
                    encryptedExpectedH1Text: "U3RyZWFtRnVzaW9u",
                    encryptedExpectedApiKey: "MzJlNWU1Mzk5OWUzODBhMDI5MWQ2NmZiMzA0MTUzZmU=",
                };

                // Almacenamiento local
                const _storage = {
                    saveLicense: (license) => localStorage.setItem("streamfusion_license", license),
                    getLicense: () => localStorage.getItem("streamfusion_license"),
                    setActivated: (value) => localStorage.setItem("streamfusion_activated", value ? "true" : "false"),
                    isActivated: () => localStorage.getItem("streamfusion_activated") === "true",
                    clearLicense: () => {
                        localStorage.removeItem("streamfusion_license");
                        localStorage.removeItem("streamfusion_activated");
                    }
                };

                // API público
                return {
                    getSettings: () => ({
                        ..._settings,
                        expectedH1Text: decode(_settings.encryptedExpectedH1Text),
                        expectedApiKey: decode(_settings.encryptedExpectedApiKey),
                    }),

                    setActivated: (value) => {
                        _settings.isActivated = value;
                    },

                    setLicenseKey: (value) => {
                        _settings.licenseKey = value;
                    },

                    storage: {
                        saveLicense: _storage.saveLicense,
                        getLicense: _storage.getLicense,
                        setActivated: _storage.setActivated,
                        isActivated: _storage.isActivated,
                        clearLicense: _storage.clearLicense
                    }
                };
            })();
                
            // MÓDULO DE VALIDACIÓN
            const Validator = (() => {
                // Submódulo de detección
                const _detector = {
                    // Obtener la API key actual del código
                    getCurrentApiKey: () => {
                        const scripts = document.querySelectorAll("script");
                        let currentApiKey = null;

                        for (const script of scripts) {
                            const content = script.textContent || "";
                            if (content.includes("const apiKey =")) {
                                const match = content.match(/const apiKey = ["']([^"']+)["']/);
                                if (match && match[1]) {
                                    currentApiKey = match[1];
                                    break;
                                }
                            }
                        }

                        return currentApiKey;
                    },
                    
                    // Obtener el texto del título actual
                    getCurrentH1Text: () => {
                        const titleElement = document.querySelector("h1");
                        return titleElement ? titleElement.textContent.trim() : null;
                    }
                };
                
                // Submódulo de verificación
                const _verifier = {
                    // Validar formato de licencia
                    validateLicenseFormat: (license) => {
                        const licenseRegex = /^SF-[A-Z0-9]{6}-[A-Z]{3}$/;
                        return licenseRegex.test(license);
                    },
                    
                    // Verificar título
                    verifyH1Text: () => {
                        const currentH1Text = _detector.getCurrentH1Text();
                        const expectedH1Text = Config.getSettings().expectedH1Text;
                        
                        if (!currentH1Text) {
                            return { valid: false, reason: "No se encontró el elemento h1" };
                        }
                        
                        return { 
                            valid: currentH1Text === expectedH1Text,
                            reason: currentH1Text !== expectedH1Text ? "Esta licencia ya ha sido usada. Código desactivado" : null
                        };
                    },
                    
                    // Verificar API key
                    verifyApiKey: () => {
                        const currentApiKey = _detector.getCurrentApiKey();
                        const expectedApiKey = Config.getSettings().expectedApiKey;
                        
                        if (!currentApiKey) {
                            return { valid: false, reason: "No se encontró la API key" };
                        }
                        
                        return { 
                            valid: currentApiKey === expectedApiKey,
                            reason: currentApiKey !== expectedApiKey ? "Esta licencia ya ha sido usada. Código desactivado" : null
                        };
                    }
                };
                
                // Submódulo de generación
                const _generator = {
                    // Generar una licencia
                    generateLicense: (customerName) => {
                        const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
                        const namePart = customerName.substring(0, 3).toUpperCase();
                        return `SF-${randomPart}-${namePart}`;
                    }
                };
                
                // API público
                return {
                    // Funciones de detección
                    detector: {
                        getCurrentApiKey: _detector.getCurrentApiKey,
                        getCurrentH1Text: _detector.getCurrentH1Text
                    },
                    
                    // Funciones de verificación
                    verifier: {
                        validateLicenseFormat: _verifier.validateLicenseFormat,
                        verifyH1Text: _verifier.verifyH1Text,
                        verifyApiKey: _verifier.verifyApiKey,
                        
                        // Verificación completa
                        verifyLicense: () => {
                            const h1Result = _verifier.verifyH1Text();
                            if (!h1Result.valid) {
                                return h1Result;
                            }
                            
                            const apiKeyResult = _verifier.verifyApiKey();
                            if (!apiKeyResult.valid) {
                                return apiKeyResult;
                            }
                            
                            return { valid: true };
                        }
                    },
                    
                    // Funciones de generación
                    generator: {
                        generateLicense: _generator.generateLicense
                    }
                }
            })()
            
            // MÓDULO DE MONITOREO
            const Monitor = (() => {
                // Variables privadas
                let _titleObserver = null
                let _titleCheckInterval = null
                let _apiKeyCheckInterval = null
                
                // Submódulo de monitoreo de título
                const _titleMonitor = {
                    // Iniciar monitoreo del título
                    start: () => {
                        const titleElement = document.querySelector("h1")
                        if (!titleElement) {
                            console.error("No se encontró el elemento h1 para monitorear")
                            return
                        }

                        console.log("Iniciando monitoreo de licencia")

                        if (_titleObserver) {
                            _titleObserver.disconnect()
                        }

                        if (_titleCheckInterval) {
                            clearInterval(_titleCheckInterval)
                        }

                        _titleObserver = new MutationObserver(() => {
                            const h1Result = Validator.verifier.verifyH1Text()
                            
                            if (!h1Result.valid) {
                                console.log("Licencia invalida. Desactivado código.")
                                StreamFusionLicense.Recovery.deactivate("Licencia invalida. Desactivado código.")
                            }
                        })

                        _titleObserver.observe(titleElement, {
                            childList: true,
                            characterData: true,
                            subtree: true,
                            attributes: true,
                        })

                        // Verificación periódica adicional
                        _titleCheckInterval = setInterval(() => {
                            const h1Result = Validator.verifier.verifyH1Text()
                            
                            if (!h1Result.valid) {
                                console.log("Licencia invalida por verificación periódica")
                                clearInterval(_titleCheckInterval)
                                StreamFusionLicense.Recovery.deactivate("Licencia invalidada.")
                            }
                        }, 5000)
                    },
                    
                    // Detener monitoreo del título
                    stop: () => {
                        if (_titleObserver) {
                            _titleObserver.disconnect()
                        }

                        if (_titleCheckInterval) {
                            clearInterval(_titleCheckInterval)
                        }
                    }
                }
                
                // Submódulo de monitoreo de API key
                const _apiKeyMonitor = {
                    // Iniciar monitoreo de API key
                    start: () => {
                        console.log("Iniciando monitoreo de la licencia")

                        if (_apiKeyCheckInterval) {
                            clearInterval(_apiKeyCheckInterval)
                        }

                        _apiKeyCheckInterval = setInterval(() => {
                            const apiKeyResult = Validator.verifier.verifyApiKey()
                            
                            if (!apiKeyResult.valid) {
                                console.log("La licencia 2 ha sido modificada.")
                                clearInterval(_apiKeyCheckInterval)
                                StreamFusionLicense.Recovery.deactivate("Esta licencia ya ha sido usada. Licencia invalidada.")
                            }
                        }, 5000)
                    },
                    
                    // Detener monitoreo de API key
                    stop: () => {
                        if (_apiKeyCheckInterval) {
                            clearInterval(_apiKeyCheckInterval)
                        }
                    }
                }
                
                // API público
                return {
                    // Iniciar todo el monitoreo
                    startAll: () => {
                        _titleMonitor.start()
                        _apiKeyMonitor.start()
                    },
                    
                    // Detener todo el monitoreo
                    stopAll: () => {
                        _titleMonitor.stop()
                        _apiKeyMonitor.stop()
                    },
                    
                    // Acceso a monitores individuales
                    title: {
                        start: _titleMonitor.start,
                        stop: _titleMonitor.stop
                    },
                    
                    apiKey: {
                        start: _apiKeyMonitor.start,
                        stop: _apiKeyMonitor.stop
                    }
                }
            })()
            
            // MÓDULO DE INTERFAZ DE USUARIO
            const UI = (() => {
                // Submódulo de diálogos
                const _dialogs = {
                    // Mostrar diálogo de activación
                    showActivationDialog: () => {
                        const dialog = document.getElementById("license-dialog")
                        const licenseInput = document.getElementById("licenseKey")
                        const activateButton = document.getElementById("activateButton")
                        const licenseMessage = document.getElementById("license-message")

                        dialog.style.display = "flex"

                        const config = Config.getSettings()
                        if (config.defaultLicense) {
                            licenseInput.value = config.defaultLicense
                        }

                        activateButton.onclick = () => {
                            const license = licenseInput.value.trim()

                            if (!license) {
                                licenseMessage.textContent = "Por favor ingresa una licencia válida"
                                licenseMessage.style.display = "block"
                                return
                            }

                            if (Validator.verifier.validateLicenseFormat(license)) {
                                StreamFusionLicense.Manager.activateLicense(license)
                                dialog.style.display = "none"
                            } else {
                                licenseMessage.textContent = "Licencia inválida. Por favor verifica e intenta nuevamente."
                                licenseMessage.style.display = "block"
                            }
                        }
                    },
                    
                    // Mostrar diálogo de generación de licencia
                    showGeneratorDialog: () => {
                        const dialog = document.createElement("div")
                        dialog.className = "license-dialog"
                        dialog.id = "generatorDialog"

                        dialog.innerHTML = `
                            <div class="license-content">
                                <h2 class="license-title">Generador de Licencia</h2>
                                <p class="license-description">Genera una clave de licencia para tu cliente</p>
                                <div class="license-input-group">
                                    <label for="customerName" class="license-label">Nombre del Cliente</label>
                                    <input type="text" id="customerName" class="license-input" placeholder="Ingresa el nombre del cliente">
                                </div>
                                <div id="licenseResult" style="margin-top: 15px; display: none;">
                                    <label for="generatedLicense" class="license-label">Licencia Generada</label>
                                    <input type="text" id="generatedLicense" class="license-input" readonly>
                                    <button id="copyButton" style="background-color: #333; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; margin-top: 10px;">Copiar</button>
                                </div>
                                <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                                    <button id="closeButton" style="background-color: #333; color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer;">Cerrar</button>
                                    <button id="generateButton" style="background-color: #e50914; color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer;">Generar Licencia</button>
                                </div>
                            </div>
                        `

                        document.body.appendChild(dialog)

                        document.getElementById("generateButton").addEventListener("click", () => {
                            const customerName = document.getElementById("customerName").value.trim()
                            if (!customerName) {
                                _notifications.showToast("Por favor ingresa el nombre del cliente", true)
                                return
                            }

                            const license = Validator.generator.generateLicense(customerName)
                            document.getElementById("generatedLicense").value = license
                            document.getElementById("licenseResult").style.display = "block"
                        })

                        document.getElementById("copyButton").addEventListener("click", () => {
                            const licenseInput = document.getElementById("generatedLicense")
                            licenseInput.select()
                            document.execCommand("copy")
                            _notifications.showToast("Licencia copiada al portapapeles")
                        })

                        document.getElementById("closeButton").addEventListener("click", () => {
                            document.body.removeChild(dialog)
                        })
                    }
                }
                
                // Submódulo de notificaciones
                const _notifications = {
                    // Mostrar estado de licencia
                    showLicenseStatus: (isValid) => {
                        const existingStatus = document.getElementById("licenseStatus")
                        if (existingStatus) {
                            document.body.removeChild(existingStatus)
                        }

                        const status = document.createElement("div")
                        status.id = "licenseStatus"
                        status.className = isValid ? "license-status license-valid" : "license-status license-invalid"
                        status.textContent = isValid ? "Licenciado" : "Sin Licencia"

                        document.body.appendChild(status)
                    },
                    
                    // Mostrar mensaje toast
                    showToast: (message, isError = false) => {
                        console.log("Toast:", message, isError ? "(Error)" : "")

                        const existingToast = document.getElementById("licenseToast")
                        if (existingToast) {
                            document.body.removeChild(existingToast)
                        }

                        const toast = document.createElement("div")
                        toast.id = "licenseToast"
                        toast.className = `license-toast ${isError ? "license-toast-error" : "license-toast-success"}`
                        toast.textContent = message
                        toast.style.opacity = "0"

                        document.body.appendChild(toast)

                        setTimeout(() => {
                            toast.style.opacity = "1"

                            setTimeout(() => {
                                toast.style.opacity = "0"

                                setTimeout(() => {
                                    if (document.body.contains(toast)) {
                                        document.body.removeChild(toast)
                                    }
                                }, 300)
                            }, 3000)
                        }, 10)
                    }
                }
                
                // Submódulo de atajos de teclado
                const _shortcuts = {
                    // Configurar atajo de teclado para generación de licencia
                    setupKeyboardShortcut: () => {
                        let keyBuffer = ""

                        window.addEventListener("keydown", (e) => {
                            if (e.target instanceof HTMLInputElement) return

                            keyBuffer = (keyBuffer + e.key).slice(-10)

                            if (keyBuffer === "genlicense") {
                                console.log("Atajo de teclado detectado: genlicense")
                                _dialogs.showGeneratorDialog()
                                keyBuffer = ""
                            }
                        })
                    }
                }
                
                // API público
                return {
                    // Inicializar UI
                    init: () => {
                        // Los estilos ya están en el HTML
                        _shortcuts.setupKeyboardShortcut()
                    },
                    
                    // Diálogos
                    dialogs: {
                        showActivation: _dialogs.showActivationDialog,
                        showGenerator: _dialogs.showGeneratorDialog
                    },
                    
                    // Notificaciones
                    notifications: {
                        showStatus: _notifications.showLicenseStatus,
                        showToast: _notifications.showToast
                    },
                    
                    // Atajos
                    shortcuts: {
                        setup: _shortcuts.setupKeyboardShortcut
                    }
                }
            })()
            
            // MÓDULO DE RECUPERACIÓN
            const Recovery = (() => {
                // Variables privadas
                let _originalBodyContent = null
                let _recoveryInterval = null
                
                // Submódulo de desactivación
                const _deactivator = {
                    // Desactivar licencia
                    deactivate: (reason) => {
                        console.log("Desactivado", reason)

                        // Actualizar estado
                        Config.setActivated(false)

                        // Detener monitoreo
                        Monitor.stopAll()

                        // Guardar el contenido original del body
                        if (!_originalBodyContent) {
                            _originalBodyContent = document.body.innerHTML
                        }

                        // Mostrar mensaje de error
                        document.body.innerHTML =
                            '<div style="display: flex; justify-content: center; flex-direction: column; text-align: center; font-family: sans-serif; background-color: #0e0e0e; color: white; height: 100vh;"><h2 style="font-size: 28px; color: red;">ACCESO DENEGADO</h2><p>Esta licencia ya ha sido usada. Por favor, contacte al proveedor y obtenga una licencia válida.</p><p>Visita: <a href="https://streamfusion.top/" style="color: green;">https://streamfusion.top/</a></p></div>'

                        UI.notifications.showToast(reason, true)
                        UI.notifications.showStatus(false)

                        // Iniciar verificación de recuperación
                        _recoveryChecker.startCheck()
                    }
                }
                
                // Submódulo de verificación de recuperación
                const _recoveryChecker = {
                    // Iniciar verificación de recuperación
                    startCheck: () => {
                        console.log("Iniciando verificación de recuperación")

                        if (_recoveryInterval) {
                            clearInterval(_recoveryInterval)
                        }

                        _recoveryInterval = setInterval(() => {
                            // Verificar si el h1 ha sido restaurado
                            const h1Result = Validator.verifier.verifyH1Text()
                            
                            // Verificar si la API key ha sido restaurada
                            const apiKeyResult = Validator.verifier.verifyApiKey()
                            
                            // Si ambos valores han sido restaurados, recuperar la aplicación
                            if (h1Result.valid && apiKeyResult.valid) {
                                console.log("Valores restaurados, recuperando aplicación")
                                _recoverer.recover()
                            }
                        }, 3000)
                    },
                    
                    // Detener verificación de recuperación
                    stopCheck: () => {
                        if (_recoveryInterval) {
                            clearInterval(_recoveryInterval)
                            _recoveryInterval = null
                        }
                    }
                }
                
                // Submódulo de recuperación
                const _recoverer = {
                    // Recuperar aplicación
                    recover: () => {
                        console.log("Recuperando aplicación")

                        // Detener verificación de recuperación
                        _recoveryChecker.stopCheck()

                        // Restaurar el contenido original del body
                        if (_originalBodyContent) {
                            document.body.innerHTML = _originalBodyContent
                            _originalBodyContent = null
                        }

                        // Reactivar licencia
                        Config.setActivated(true)

                        const settings = Config.getSettings()

                        // Si no hay una licencia almacenada, usar la predeterminada
                        if (!Config.storage.getLicense()) {
                            Config.storage.saveLicense(settings.defaultLicense)
                            Config.setLicenseKey(settings.defaultLicense)
                        } else {
                            Config.setLicenseKey(Config.storage.getLicense())
                        }

                        // Marcar como activado
                        Config.storage.setActivated(true)

                        // Reiniciar monitoreo
                        Monitor.startAll()

                        // Actualizar UI
                        UI.notifications.showStatus(true)
                        UI.notifications.showToast("Aplicación recuperada correctamente")

                        // Reinicializar la aplicación
                        initializeApp()
                    }
                }
                
                // API público
                return {
                    // Desactivar licencia
                    deactivate: _deactivator.deactivate,
                    
                    // Verificación de recuperación
                    checker: {
                        start: _recoveryChecker.startCheck,
                        stop: _recoveryChecker.stopCheck
                    },
                    
                    // Recuperación
                    recover: _recoverer.recover
                }
            })()
            
            // MÓDULO DE GESTIÓN
            const Manager = (() => {
                // Submódulo de inicialización
                const _initializer = {
                    // Inicializar el sistema de licencias
                    init: () => {
                        console.log("Inicializando sistema de licencia...")

                        // Inicializar UI
                        UI.init()

                        // Verificar licencia actual
                        const verificationResult = Validator.verifier.verifyLicense()

                        if (verificationResult.valid) {
                            console.log("Licencia y Licencia 2 válidos, activando automáticamente")

                            // Comprobar si ya hay una licencia almacenada
                            const storedLicense = Config.storage.getLicense()
                            const settings = Config.getSettings()

                            // Usar la licencia almacenada o la predeterminada
                            const licenseKey = storedLicense || settings.defaultLicense
                            Config.setLicenseKey(licenseKey)

                            // Guardar en localStorage si no existe
                            if (!storedLicense) {
                                Config.storage.saveLicense(licenseKey)
                            }

                            // Marcar como activado
                            Config.storage.setActivated(true)
                            Config.setActivated(true)

                            // Iniciar monitoreo
                            Monitor.startAll()

                            // Mostrar indicador de licencia
                            UI.notifications.showStatus(true)
                            
                            // Actualizar variable global
                            isLicenseValid = true;

                            // Inicializar la aplicación
                            initializeApp()
                        } else {
                            console.log("Verificación fallida:", verificationResult.reason)
                            UI.notifications.showToast("Error: Licencia inválida", true)
                            UI.dialogs.showActivation()
                        }
                    }
                }
                
                // Submódulo de activación
                const _activator = {
                    // Activar una licencia
                    activateLicense: (licenseKey) => {
                        const verificationResult = Validator.verifier.verifyLicense()

                        if (!verificationResult.valid) {
                            UI.notifications.showToast(verificationResult.reason, true)
                            return
                        }

                        const isLicenseValid = Validator.verifier.validateLicenseFormat(licenseKey)

                        if (isLicenseValid) {
                            console.log("Licencia válida, activando...")
                            Config.setActivated(true)
                            Config.setLicenseKey(licenseKey)

                            // Guardar en localStorage
                            Config.storage.saveLicense(licenseKey)
                            Config.storage.setActivated(true)

                            // Iniciar monitoreo
                            Monitor.startAll()

                            UI.notifications.showToast("Licencia activada correctamente")
                            UI.notifications.showStatus(true)
                            
                            // Actualizar variable global
                            window.isLicenseValid = true;

                            // Inicializar la aplicación
                            initializeApp()
                        } else {
                            console.log("Licencia inválida")
                            UI.notifications.showToast("La clave de licencia es inválida", true)
                        }
                    }
                }
                
                // API público
                return {
                    // Inicializar
                    init: _initializer.init,
                    
                    // Activar licencia
                    activateLicense: _activator.activateLicense
                }
            })()
            
            // INICIALIZACIÓN Y API PÚBLICA
            const publicAPI = {
                // Módulos internos (para uso interno)
                Config: Config,
                Validator: Validator,
                Monitor: Monitor,
                UI: UI,
                Recovery: Recovery,
                Manager: Manager,

                // API pública para uso externo
                init: () => {
                    Manager.init()
                },
                
                activateLicense: (licenseKey) => {
                    Manager.activateLicense(licenseKey)
                },
                
                generateLicense: (customerName) => {
                    return Validator.generator.generateLicense(customerName)
                },
                
                validateLicense: (license) => {
                    return Validator.verifier.validateLicenseFormat(license)
                },
                
                showActivationDialog: () => {
                    UI.dialogs.showActivation()
                },
                
                showGeneratorDialog: () => {
                    UI.dialogs.showGenerator()
                },
                
                showToast: (message, isError) => {
                    UI.notifications.showToast(message, isError)
                }
            }

            return publicAPI
        })();

        // Funciones para el reproductor
        function switchPlayer(type) {
            const players = document.querySelectorAll('.player');
            players.forEach(player => player.classList.remove('active'));

            startMessage.style.display = 'none';
            reloadButton.style.display = 'block';

            if (type === 'iframe') {
                iframePlayer.classList.add('active');
            } else {
                videoPlayer.classList.add('active');
            }
        }

        function stopActivePlayer() {
            // Detener el reproductor de video
            if (videoPlayer && !videoPlayer.paused) {
                videoPlayer.pause();
                videoPlayer.src = '';
                videoPlayer.load();
            }

            // Limpiar el reproductor de iframe
            if (iframePlayer) {
                iframePlayer.src = '';
            }

            // Limpiar el reproductor HLS si está inicializado
            if (hlsInstance) {
                hlsInstance.destroy();
                hlsInstance = null;
            }

            // Ocultar el mensaje de error
            errorMessage.style.display = 'none';
            reloadButton.style.display = 'none';
        }

        function showSpinner() {
            spinner.style.display = 'block';
            errorMessage.style.display = 'none';
            startMessage.style.display = 'none';
        }

        function hideSpinner() {
            spinner.style.display = 'none';
        }

        function showError() {
            errorMessage.style.display = 'block';
            spinner.style.display = 'none';
            startMessage.style.display = 'none';
        }

        function playChannel(channel) {
            // Mostrar el spinner mientras se carga el canal
            showSpinner();

            // Detener el reproductor activo antes de cambiar
            stopActivePlayer();

            // Guardar el canal actual
            currentChannel = channel;
            currentVideoUrl = channel.source;

            // Cambiar al reproductor adecuado
            switchPlayer(channel.type);

            if (channel.type === 'hls') {
                // HLS stream
                if (Hls.isSupported()) {
                    hlsInstance = new Hls();
                    hlsInstance.loadSource(channel.source);
                    hlsInstance.attachMedia(videoPlayer);

                    // Manejar errores de HLS
                    hlsInstance.on(Hls.Events.ERROR, function (event, data) {
                        if (data.fatal) {
                            console.error('Error fatal en HLS:', data);
                            showError();
                        }
                    });

                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                        videoPlayer.play().catch(() => {
                            showError();
                        });
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    videoPlayer.src = channel.source;
                    videoPlayer.play().catch(() => {
                        showError();
                    });
                } else {
                    showError();
                }

                // Ocultar el mensaje de error cuando el video empiece a reproducirse
                videoPlayer.onplaying = function () {
                    hideSpinner();
                    errorMessage.style.display = 'none';
                };
            } else if (channel.type === 'iframe') {
                // Iframe embed
                iframePlayer.src = channel.source;

                // Ocultar spinner después de cargar el iframe
                iframePlayer.onload = function () {
                    hideSpinner();
                    errorMessage.style.display = 'none';
                };

                iframePlayer.onerror = function () {
                    showError();
                };
            }

            // Ocultar el overlay después de seleccionar un canal
            hideOverlay();
        }

        function reloadCurrentVideo() {
            if (!currentChannel) return;
            
            reloadButton.classList.add('loading');
            
            if (currentChannel.type === 'hls') {
                videoPlayer.src = '';
                
                setTimeout(() => {
                    if (Hls.isSupported()) {
                        if (hlsInstance) {
                            hlsInstance.destroy();
                        }
                        
                        hlsInstance = new Hls();
                        hlsInstance.loadSource(currentChannel.source);
                        hlsInstance.attachMedia(videoPlayer);
                        
                        hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
                            videoPlayer.play().catch(() => {
                                showError();
                            });
                        });
                    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                        videoPlayer.src = currentChannel.source;
                        videoPlayer.play().catch(() => {
                            showError();
                        });
                    }
                    
                    setTimeout(() => {
                        reloadButton.classList.remove('loading');
                    }, 1000);
                }, 1000);
            } else if (currentChannel.type === 'iframe') {
                iframePlayer.src = 'about:blank';
                
                setTimeout(() => {
                    iframePlayer.src = currentChannel.source;
                    
                    setTimeout(() => {
                        reloadButton.classList.remove('loading');
                    }, 1000);
                }, 1000);
            }
        }

        // Funciones para categorías y canales
        function renderCategories() {
            const categoryList = document.getElementById('category-list');
            const overlayList = document.getElementById('overlay-category-list');
            
            // Limpiar listas
            categoryList.innerHTML = '';
            overlayList.innerHTML = '';
            
            // Renderizar categorías
            categories.forEach(category => {
                // Categorías en la barra lateral
                const listItem = document.createElement('li');
                const button = document.createElement('button');
                button.textContent = category.name;
                button.onclick = () => filterChannels(category.id);
                if (category.id === 'all') {
                    button.classList.add('selected');
                    selectedCategoryButton = button;
                }
                listItem.appendChild(button);
                categoryList.appendChild(listItem);
                
                // Categorías en el overlay
                const overlayItem = document.createElement('li');
                const overlayButton = document.createElement('button');
                overlayButton.textContent = category.name;
                overlayButton.onclick = () => {
                    filterChannels(category.id);
                    updateOverlayCategorySelection(category.id);
                };
                if (category.id === 'all') {
                    overlayButton.classList.add('selected');
                }
                overlayItem.appendChild(overlayButton);
                overlayList.appendChild(overlayItem);
            });
        }

        function renderChannels() {
            const channelList = document.getElementById('channel-list');
            const overlayChannelList = document.getElementById('overlay-channel-list');
            
            // Limpiar listas
            channelList.innerHTML = '';
            overlayChannelList.innerHTML = '';
            
            // Renderizar canales
            channels.forEach(channel => {
                // Canales en la barra lateral
                const channelItem = document.createElement('div');
                channelItem.className = 'channel-item';
                channelItem.dataset.category = channel.categories.join(',');
                channelItem.dataset.id = channel.id;
                
                const logoDiv = document.createElement('div');
                logoDiv.className = 'channel-logo';
                logoDiv.style.backgroundImage = `url('${channel.logo}')`;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'channel-name';
                nameDiv.textContent = channel.name;
                
                channelItem.appendChild(logoDiv);
                channelItem.appendChild(nameDiv);
                channelItem.onclick = () => {
                    selectChannel(channelItem);
                    playChannel(channel);
                };
                
                channelList.appendChild(channelItem);
                
                // Canales en el overlay
                const overlayItem = channelItem.cloneNode(true);
                overlayItem.onclick = () => {
                    selectChannel(overlayItem);
                    playChannel(channel);
                };
                overlayChannelList.appendChild(overlayItem);
            });
        }

        function filterChannels(categoryId) {
            const channelItems = document.querySelectorAll('.channel-item');
            
            // Actualizar botón de categoría seleccionado
            if (selectedCategoryButton) {
                selectedCategoryButton.classList.remove('selected');
            }
            
            const categoryButtons = document.querySelectorAll('#category-list button');
            categoryButtons.forEach(button => {
                if (button.textContent === categories.find(c => c.id === categoryId)?.name) {
                    button.classList.add('selected');
                    selectedCategoryButton = button;
                }
            });
            
            // Filtrar canales
            channelItems.forEach(item => {
                const channelCategories = item.dataset.category.split(',');
                if (categoryId === 'all' || channelCategories.includes(categoryId)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function updateOverlayCategorySelection(categoryId) {
            const overlayButtons = document.querySelectorAll('#overlay-category-list button');
            overlayButtons.forEach(button => {
                button.classList.remove('selected');
                if (button.textContent === categories.find(c => c.id === categoryId)?.name) {
                    button.classList.add('selected');
                }
            });
        }

        function selectChannel(channelItem) {
            // Desresaltar el canal previamente seleccionado
            const allChannelItems = document.querySelectorAll('.channel-item');
            allChannelItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            // Resaltar el canal seleccionado
            channelItem.classList.add('selected');
            
            // Resaltar también el mismo canal en la otra lista
            const channelId = channelItem.dataset.id;
            const otherItems = document.querySelectorAll(`.channel-item[data-id="${channelId}"]`);
            otherItems.forEach(item => {
                item.classList.add('selected');
            });
        }

        function filterChannelsBySearch(context) {
            const searchBar = context === 'sidebar' ? sidebarSearchBar : overlaySearchBar;
            const query = searchBar.value.toLowerCase();
            const channelList = context === 'sidebar' ? 
                document.getElementById('channel-list') : 
                document.getElementById('overlay-channel-list');
            
            const channelItems = channelList.querySelectorAll('.channel-item');
            
            channelItems.forEach(item => {
                const channelName = item.querySelector('.channel-name').textContent.toLowerCase();
                if (channelName.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Funciones para pantalla completa
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Entrar en pantalla completa
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.mozRequestFullScreen) {
                    videoContainer.mozRequestFullScreen();
                } else if (videoContainer.webkitRequestFullscreen) {
                    videoContainer.webkitRequestFullscreen();
                } else if (videoContainer.msRequestFullscreen) {
                    videoContainer.msRequestFullscreen();
                }

                // Rotar automáticamente la pantalla a modo horizontal
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(err => {
                        console.warn('No se pudo bloquear la orientación:', err);
                    });
                }
            } else {
                // Salir de pantalla completa
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                // Restaurar la orientación a modo vertical
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            }
        }

        function toggleMenu() {
            if (fullscreenOverlay.style.display === 'block') {
                hideOverlay();
            } else {
                showOverlay();
            }
        }

        function showOverlay() {
            fullscreenOverlay.style.display = 'block';
        }

        function hideOverlay() {
            fullscreenOverlay.style.display = 'none';
        }

        function adjustVideoContainer() {
            if (document.fullscreenElement) {
                // En modo de pantalla completa, forzar que el contenedor ocupe toda la pantalla
                videoContainer.style.width = '100vw';
                videoContainer.style.height = '100vh';
                videoContainer.style.paddingTop = '0';
                fullscreenMenu.style.display = 'block';
            } else {
                // Fuera de pantalla completa, restaurar el diseño original
                videoContainer.style.width = '';
                videoContainer.style.height = '';
                videoContainer.style.paddingTop = '';
                fullscreenMenu.style.display = 'none';
                hideOverlay();
            }
        }

        // Inicialización de la aplicación
        function initializeApp() {
            // Inicializar categorías y canales
            renderCategories();
            renderChannels();
            
            // Filtrar por la categoría "all" por defecto
            filterChannels('all');
            
            // Event listeners para búsqueda
            sidebarSearchBar.addEventListener('input', () => filterChannelsBySearch('sidebar'));
            overlaySearchBar.addEventListener('input', () => filterChannelsBySearch('overlay'));
            
            // Event listener para botón de pantalla completa
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // Event listener para botón de recarga
            reloadButton.addEventListener('click', reloadCurrentVideo);
            
            // Event listener para menú en pantalla completa
            fullscreenMenu.querySelector('i').addEventListener('click', toggleMenu);
            
            // Event listener para cerrar overlay al hacer clic fuera del contenido
            fullscreenOverlay.addEventListener('click', function(event) {
                if (event.target === fullscreenOverlay) {
                    hideOverlay();
                }
            });
            
            // Evitar que los clics dentro del overlay lo cierren
            overlayContent.addEventListener('click', function(event) {
                event.stopPropagation();
            });
            
            // Event listeners para cambios en pantalla completa
            document.addEventListener('fullscreenchange', adjustVideoContainer);
            document.addEventListener('webkitfullscreenchange', adjustVideoContainer);
            document.addEventListener('mozfullscreenchange', adjustVideoContainer);
            document.addEventListener('MSFullscreenChange', adjustVideoContainer);
        }

        // Event listeners para cambios en la orientación o redimensionamiento
        window.addEventListener('resize', adjustVideoContainer);
        window.addEventListener('orientationchange', adjustVideoContainer);

        // Inicializar el sistema de licencia cuando el documento esté listo
        document.addEventListener("DOMContentLoaded", () => {
            // Inicializar el sistema de licencia
            StreamFusionLicense.init();
        });
    </script>
</body>
</html>
